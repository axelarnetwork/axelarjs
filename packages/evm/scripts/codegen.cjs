#!/usr/bin/env node

const path = require("path");
const fs = require("fs");
const prettier = require("prettier");

const kebabToPascalCase = (str = "") =>
  str
    .split("-")
    .reduce((acc, x) => acc.concat(x[0].toUpperCase().concat(x.slice(1))), "");

const kebabToConstantCase = (str = "") => str.toUpperCase().replace(/\-/g, "_");

const capitalize = (str = "") => str[0].toUpperCase().concat(str.slice(1));

const PACKAGE_NAME = "@axelar-network/interchain-token-service";

const CONTRACT_FOLDERS = [
  "interchain-token-service",
  "interchain-token",
  "token-manager",
];

const getInputType = (input) => {
  switch (input.type) {
    // string types
    case "address":
    case "bytes32":
    case "bytes":
      return "`0x${string}`";
    case "string":
      return "string";
    // number types
    case "uint256":
    case "uint8":
      return "bigint";
    // boolean
    case "bool":
      return "boolean";
    // default
    default:
      return "any";
  }
};

async function main() {
  for (const folder of CONTRACT_FOLDERS) {
    const pascalName = kebabToPascalCase(folder);
    const constantName = kebabToConstantCase(folder);

    const {
      contractName,
      abi,
    } = require(`${PACKAGE_NAME}/dist/${folder}/${pascalName}.sol/${pascalName}.json`);

    const indexFile = `
/**
 * This file was generated by scripts/codegen.cjs
 * DO NOT EDIT MANUALLY
 */    
import { Chain } from "viem";

import { PublicContractClient } from "../PublicContractClient";
import ABI_FILE from "./${folder}.abi";
export * as  ${constantName}_ARGS from "./${folder}.args";
export type * as ${constantName}_TYPES from "./${folder}.args";

export const ${constantName}_ABI = ABI_FILE.abi;

export class ${contractName}Client extends PublicContractClient<
  typeof ABI_FILE.abi
> {
  static ABI = ABI_FILE.abi;
  static contractName = ABI_FILE.contractName;

  constructor(options: { chain: Chain; address: \`0x\${string}\` }) {
    super({
      abi: ${constantName}_ABI,
      address: options.address,
      chain: options.chain,
    });
  }
}`;

    const abiJsonFile = `${JSON.stringify({ contractName, abi }, null, 2)}`;

    const abiFile = `
/**
 * This file was generated by scripts/codegen.cjs
 * 
 * Original abi file: 
 * - ${PACKAGE_NAME}/dist/${folder}/${pascalName}.sol/${pascalName}.json
 * 
 * DO NOT EDIT MANUALLY
 */

export default ${abiJsonFile} as const;`;

    const basePath = path.join(__dirname, "..", "src", "contracts", folder);

    // create folder if it doesn't exist
    if (!fs.existsSync(basePath)) {
      fs.mkdirSync(basePath);
    }

    // write index file
    fs.writeFileSync(
      path.join(basePath, "index.ts"),
      prettier.format(indexFile, { parser: "babel-ts" })
    );

    // write abi file
    fs.writeFileSync(
      path.join(basePath, `${folder}.abi.ts`),
      prettier.format(abiFile, { parser: "babel-ts" })
    );

    // write abi json file
    fs.writeFileSync(
      path.join(basePath, `${folder}.abi.json`),
      prettier.format(abiJsonFile, { parser: "json" })
    );

    // only generate args file if there are functions with inputs
    const abiFns = abi.filter(
      (x) =>
        x.type === "function" &&
        x.inputs.length &&
        x.inputs.every((input) => input.name)
    );

    const fnArgsFactories = abiFns
      .map(({ name, inputs }) => {
        const args = inputs.map((input) => `args.${input.name}`).join(", ");

        const argsType = inputs
          .map((input) => `${input.name}: ${getInputType(input)}`)
          .join("; ");

        const typeName = `${capitalize(name)}Args`;
        const typeAliasExport = `export type ${typeName} = {${argsType}}`;
        const fnExport = `export const ${name} = (args: ${typeName}) => [${args}] as const;`;

        return `${typeAliasExport}\n\n${fnExport}`;
      })
      .join("\n\n");

    fs.writeFileSync(
      path.join(basePath, `${folder}.args.ts`),
      prettier.format(fnArgsFactories, { parser: "babel-ts" })
    );

    console.log(`Synced ${folder} contract ABI.`, {
      functions: abiFns.length,
    });
  }

  console.log(
    `Synced ${CONTRACT_FOLDERS.length} contract ABIs.\n`,
    "Generated code can be found in ./src/contracts"
  );
}

main();
